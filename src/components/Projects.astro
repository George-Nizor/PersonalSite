---
const fetchRepo = async (fullName: string) => {
  try {
    const token = (import.meta as any)?.env?.GITHUB_TOKEN || process?.env?.GITHUB_TOKEN;
    const headers: Record<string, string> = {
      'Accept': 'application/vnd.github+json',
      'User-Agent': 'GeorgeNizoridis-PersonalSite',
      'X-GitHub-Api-Version': '2022-11-28'
    };
    if (token) headers['Authorization'] = `Bearer ${token}`;
    const res = await fetch(`https://api.github.com/repos/${fullName}` , { headers, cache: 'no-store' });
    if (!res.ok) {
      console.warn('GitHub API error for', fullName, res.status, res.statusText, 'remaining:', res.headers.get('x-ratelimit-remaining'));
      return null;
    }
    return (await res.json()) as any;
  } catch (err) {
    console.error('GitHub fetch failed for', fullName, err);
    return null;
  }
};

const reposToFetch = [
  'George-Nizor/Binary-Image-Classification',
  'George-Nizor/ML-Project-Heart-attack',
  'Bonehead-Labs/frontier-model-framework',
  'Bonehead-Labs/PBIP-Factory',
  'Bonehead-Labs/BoneheadLabsSite',
  'Bonehead-Labs/bonehead-labs-official-systems'
];

const fetched = await Promise.all(reposToFetch.map(fetchRepo));
const repoData = reposToFetch.map((fullName, idx) => {
  const repo = fetched[idx];
  if (repo && repo.name) return repo;
  const namePart = fullName.split('/')[1] ?? fullName;
  return {
    full_name: fullName,
    name: namePart.replace(/[-_]/g, ' '),
    description: undefined,
    language: undefined,
    stargazers_count: undefined,
    html_url: `https://github.com/${fullName}`
  } as any;
});

const repoMeta: Record<string, { category: string; problem: string; tech: string; benefits: string }> = {
  'George-Nizor/Binary-Image-Classification': {
    category: 'Machine-Learning',
    problem: 'Classify images into two categories with high accuracy.',
    tech: 'Python, TensorFlow, Keras, Pillow',
    benefits: 'Reliable binary predictions for downstream decisions. Used in contract to save time and money.'
  },
  'George-Nizor/ML-Project-Heart-attack': {
    category: 'Machine-Learning',
    problem: 'Estimate heart-attack risk from patient attributes.',
    tech: 'Python, scikit-learn, Pandas, model evaluation/ROC-AUC',
    benefits: 'Refined Machine learning pipeline understanding.'
  },
  'Bonehead-Labs/frontier-model-framework': {
    category: 'AI-Engineering',
    problem: 'Orchestrate LLM components for end-to-end use-cases.',
    tech: 'Python, AWS Bedrock, Azure OpenAI, LangChain, Microsoft Graph API, Boto3',
    benefits: 'Used to rapidly prototype and deploy Managed service LLM powered applications.'
  },
  'Bonehead-Labs/PBIP-Factory': {
    category: 'Analytics-Engineering',
    problem: 'Automate replication of Power BI reports using Master Template and CLI tool',
    tech: 'Python, TMDL, Power BI PBIP',
    benefits: 'Improved Analytics Workflow via automation driven efficiency.'
  },
  'Bonehead-Labs/BoneheadLabsSite': {
    category: 'Web-Development',
    problem: 'Publish a fast, content-focused site for the lab.',
    tech: 'React, Tailwind CSS',
    benefits: 'Visually appealing and functional website representing the Bonehead Labs brand.'
  },
  'Bonehead-Labs/bonehead-labs-official-systems': {
    category: 'Game Development | Open Source',
    problem: 'Open source re-usable game modules compatible with the Godot Engine',
    tech: 'Godot, GDScript',
    benefits: 'Accelerates game development by providing a library of reusable modules, and provides value to the community.'
  }
};

const categoryIconMap: Record<string, string> = {
  'AI-Engineering': 'mdi:robot-outline',
  'Machine-Learning': 'mdi:brain',
  'Analytics-Engineering': 'mdi:chart-box-outline',
  'Web-Development': 'mdi:web',
  'Web-Engineering': 'mdi:web',
  'Platform-Engineering': 'mdi:server-cog-outline',
  'Back-End Engineering': 'mdi:server',
  'Data-Architecture': 'mdi:database-cog-outline',
  'Data-Modeling': 'mdi:table-pivot',
  'Game Development | Open Source': 'mdi:gamepad-variant-outline'
};

const languageIconMap: Record<string, string> = {
  'Python': 'logos:python',
  'TypeScript': 'logos:typescript-icon',
  'JavaScript': 'logos:javascript',
  'Jupyter Notebook': 'logos:jupyter',
  'GDScript': 'logos:godot-icon',
  'HTML': 'logos:html-5',
  'CSS': 'logos:css-3'
};

const getIconForRepo = (repo: any): string => {
  const category = repoMeta[repo?.full_name]?.category;
  if (category && categoryIconMap[category]) return categoryIconMap[category];
  const language = repo?.language;
  if (language && languageIconMap[language]) return languageIconMap[language];
  return 'mdi:folder-outline';
};

const getIconForCategory = (category: string): string => categoryIconMap[category] ?? 'mdi:folder-outline';
---
<section id="projects" class="mx-auto mt-24 max-w-6xl">
  <div class="section-shell relative border-2 border-white/20 px-8 py-12 md:px-12" data-reveal>
    <header class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
      <div>
        <h2 class="flex items-center gap-3 text-3xl font-semibold text-white md:text-4xl">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-white/10">
            <iconify-icon icon="mdi:folder-star-outline" width="18" height="18" class="text-white/80"></iconify-icon>
          </span>
          My Projects
        </h2>
        <p class="mt-2 max-w-2xl text-white/70">Scroll to explore recent work across AI, analytics, and engineering.</p>
      </div>
      <button id="toggle-projects" type="button" aria-controls="projects-container" aria-expanded="true" class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/5 px-4 py-2 text-sm text-white/80 transition hover:bg-white/10 hover:text-white cursor-pointer z-10 relative" style="pointer-events: auto !important;">
        <span id="toggle-text">Hide projects</span> <span id="toggle-icon">↑</span>
      </button>
    </header>

    <div id="projects-container" class="mt-8 rounded-xl border border-white/10 bg-white/5" data-reveal>

      <div id="projects-list" class="h-[560px] md:h-[600px] space-y-4 overflow-y-auto p-4" style="scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.3) transparent;">
        <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
            <iconify-icon icon={getIconForCategory('AI-Engineering')} width="48" height="48" class="text-white/80"></iconify-icon>
          </div>
          <div class="flex-1">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">AI-Engineering</p>
            <h3 class="mt-1 text-lg font-semibold text-white">🔒 A.I Evidence Validation</h3>
            <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
              <li><span class="text-white/90">Problem:</span> Verify evidence against complex, multi‑step requirements at scale.</li>
              <li><span class="text-white/90">Tech:</span> Multi‑modal LLMs, retrieval, evaluation guardrails, vector search.</li>
              <li><span class="text-white/90">Benefits:</span> Faster compliance checks with higher consistency and traceability.</li>
            </ul>
          </div>
        </article>

        <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
            <iconify-icon icon={getIconForCategory('AI-Engineering')} width="48" height="48" class="text-white/80"></iconify-icon>
          </div>
          <div class="flex-1">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">AI-Engineering</p>
            <h3 class="mt-1 text-lg font-semibold text-white">🔒 A.I Invoice Data Extraction</h3>
            <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
              <li><span class="text-white/90">Problem:</span> Extract structured data from varied invoice formats reliably.</li>
              <li><span class="text-white/90">Tech:</span> AWS Textract/Rekognition, Bedrock, parsing/validation pipeline.</li>
              <li><span class="text-white/90">Benefits:</span> Reduced manual data entry and faster AP processing.</li>
            </ul>
          </div>
        </article>

        {repoData.map((repo) => (
          <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
            <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
              <iconify-icon icon={getIconForRepo(repo)} width="48" height="48" class="text-white/80"></iconify-icon>
            </div>
            <div class="flex-1">
              <p class="text-xs uppercase tracking-[0.3em] text-white/60">{repoMeta[repo?.full_name]?.category ?? (repo?.language ?? 'Project')}</p>
              <h3 class="mt-1 text-lg font-semibold text-white">{repo?.name ?? 'Repository'}</h3>
              <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
                <li><span class="text-white/90">Problem:</span> {repoMeta[repo?.full_name]?.problem ?? (repo?.description ?? 'Solves a focused user problem.')}</li>
                <li><span class="text-white/90">Tech:</span> {repoMeta[repo?.full_name]?.tech ?? (repo?.language ?? 'Multiple')}</li>
                <li><span class="text-white/90">Benefits:</span> {repoMeta[repo?.full_name]?.benefits ?? 'Clear value with practical outcomes.'}</li>
              </ul>
              <div class="mt-2 flex flex-wrap gap-2 text-xs text-white/70">
                {repo?.language && <span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">{repo.language}</span>}
                {repo?.stargazers_count !== undefined && (<span class="rounded-full border border-white/10 bg-white/5 px-2 py-1">★ {repo.stargazers_count}</span>)}
                {repo?.html_url && (
                  <a class="inline-flex items-center gap-1 text-white/80 hover:text-white" href={repo.html_url} target="_blank" rel="noopener">GitHub ↗</a>
                )}
              </div>
            </div>
          </article>
        ))}

        <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
            <iconify-icon icon={getIconForCategory('Data-Architecture')} width="48" height="48" class="text-white/80"></iconify-icon>
          </div>
          <div class="flex-1">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">Data-Architecture</p>
            <h3 class="mt-1 text-lg font-semibold text-white">🏛️ Medallion Architecture</h3>
            <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
              <li><span class="text-white/90">Problem:</span> Standardize and govern data products across domains.</li>
              <li><span class="text-white/90">Tech:</span> Microsoft Fabric (Lakehouse, Dataflows), Spark SQL, T‑SQL, PySpark.</li>
              <li><span class="text-white/90">Benefits:</span> Trustworthy datasets, faster delivery, and predictable performance.</li>
            </ul>
          </div>
        </article>

        <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
            <iconify-icon icon={getIconForCategory('Back-End Engineering')} width="48" height="48" class="text-white/80"></iconify-icon>
          </div>
          <div class="flex-1">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">Back-End Engineering</p>
            <h3 class="mt-1 text-lg font-semibold text-white">N8N Automation Server</h3>
            <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
              <li><span class="text-white/90">Problem:</span> Reduce manual, repetitive tasks across apps and services.</li>
              <li><span class="text-white/90">Tech:</span> n8n, AI agents, webhooks, REST APIs, Docker, PostgreSQL.</li>
              <li><span class="text-white/90">Benefits:</span> Automated workflows, faster turnaround, and fewer errors.</li>
            </ul>
          </div>
        </article>

        <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
            <iconify-icon icon={getIconForCategory('Back-End Engineering')} width="48" height="48" class="text-white/80"></iconify-icon>
          </div>
          <div class="flex-1">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">Back-End Engineering</p>
            <h3 class="mt-1 text-lg font-semibold text-white">Nextcloud Self‑Hosted Cloud</h3>
            <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
              <li><span class="text-white/90">Problem:</span> Own and manage personal cloud storage across devices securely.</li>
              <li><span class="text-white/90">Tech:</span> Nextcloud, Linux, Docker, reverse proxy, backups.</li>
              <li><span class="text-white/90">Benefits:</span> Private, reliable storage and sync with full control.</li>
            </ul>
          </div>
        </article>

        <article class="flex gap-4 rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border border-white/10 bg-white/5 flex items-center justify-center">
            <iconify-icon icon={getIconForCategory('Data-Modeling')} width="48" height="48" class="text-white/80"></iconify-icon>
          </div>
          <div class="flex-1">
            <p class="text-xs uppercase tracking-[0.3em] text-white/60">Data-Modeling</p>
            <h3 class="mt-1 text-lg font-semibold text-white">🧩 Data Modelling</h3>
            <ul class="mt-2 list-disc space-y-1 pl-5 text-sm text-white/75">
              <li><span class="text-white/90">Problem:</span> Provide governed, reusable metrics for varied business questions.</li>
              <li><span class="text-white/90">Tech:</span> DirectLake, semantic models, DAX, tabular modeling, governance.</li>
              <li><span class="text-white/90">Benefits:</span> Self‑serve analytics with consistent, single‑source metrics.</li>
            </ul>
          </div>
        </article>
      </div>
    </div>
  </div>

  <script>
    // Wait for the page to fully load
    window.addEventListener('load', function() {
      console.log('Page loaded, initializing projects...');
      
      const btn = document.getElementById('toggle-projects');
      const container = document.getElementById('projects-container');
      const icon = document.getElementById('toggle-icon');
      const text = document.getElementById('toggle-text');
      
      console.log('Elements found:', {
        btn: !!btn,
        container: !!container,
        icon: !!icon,
        text: !!text
      });
      
      if (!btn || !container || !icon || !text) {
        console.error('Missing required elements');
        return;
      }

      let isOpen = true;
      
      btn.onclick = function(event) {
        console.log('Button clicked! Event:', event, 'current state:', isOpen);
        isOpen = !isOpen;
        
        if (isOpen) {
          container.style.display = 'block';
          container.classList.remove('hidden');
          icon.textContent = '↑';
          text.textContent = 'Hide projects';
        } else {
          container.style.display = 'none';
          container.classList.add('hidden');
          icon.textContent = '↓';
          text.textContent = 'Show projects';
        }
        
        console.log('New state:', isOpen);
      };
      
      console.log('Projects toggle initialized successfully');
    });
  </script>
</section>
